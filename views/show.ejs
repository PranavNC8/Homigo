<% layout("/layouts/boilerplate") %>

<body>
<div class="container my-5">

  <!-- Listing Card -->
  <div class="card listing-card shadow-lg border-0" style="max-width: 850px; margin: auto; overflow: hidden;">
    <img src="<%= listingbyid.image.url %>" class="card-img-top" alt="<%= listingbyid.title %>" style="max-height: 400px; object-fit: cover;">
    <div class="card-body">
      <h2 class="card-title text-primary fw-bold"><%= listingbyid.title %></h2>
      <p class="card-text text-muted mb-2"><%= listingbyid.description %></p>

      <ul class="list-unstyled mb-3">
        <li><strong>Price:</strong> ‚Çπ<%= listingbyid.price %>/Day</li>
        <li><strong>Location:</strong> <%= listingbyid.location %>, <%= listingbyid.country %></li>
        <li><strong>Owner:</strong> <%= listingbyid.owner.username %></li>
      </ul>

      <% if(currUser && currUser._id.equals(listingbyid.owner._id)) { %>
        <div class="d-flex gap-2">
          <a href="/listings/<%= listingbyid._id %>/edit" class="btn btn-outline-primary">Edit</a>
          <form action="/listings/<%= listingbyid._id %>?_method=DELETE" method="post">
            <button class="btn btn-outline-danger">Delete</button>
          </form>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Map -->
  <div class="card shadow-sm border-0 mt-4" style="max-width: 850px; margin: auto;">
    <div class="card-body">
      <h5 class="text-secondary mb-3">üìç Location Map</h5>
      <div id="map" style="height: 400px; border-radius: 12px;"></div>
    </div>
  </div>

  <!-- Review Form -->
  <% if (currUser) { %>
    <div class="card shadow-sm border-0 p-4 mt-4" style="max-width: 850px; margin: auto;">
      <h4 class="text-success mb-3">üí¨ Leave a Review</h4>
      <form action="/listings/<%= listingbyid._id %>/reviews" method="post">
        <fieldset class="starability-slot mb-3">
          <legend>Rating:</legend>
          <input type="radio" id="rate1" name="review[rating]" value="1" />
          <label for="rate1">1 star</label>
          <input type="radio" id="rate2" name="review[rating]" value="2" />
          <label for="rate2">2 stars</label>
          <input type="radio" id="rate3" name="review[rating]" value="3" />
          <label for="rate3">3 stars</label>
          <input type="radio" id="rate4" name="review[rating]" value="4" />
          <label for="rate4">4 stars</label>
          <input type="radio" id="rate5" name="review[rating]" value="5" />
          <label for="rate5">5 stars</label>
        </fieldset>

        <div class="mb-3">
          <label for="comment" class="form-label fw-semibold">Comment</label>
          <textarea class="form-control" id="comment" name="review[Comment]" rows="3" placeholder="Write something..." required></textarea>
        </div>

        <button type="submit" class="btn btn-success px-4">Submit</button>
      </form>
    </div>
  <% } %>

  <!-- Reviews -->
  <div class="card shadow-sm border-0 p-4 mt-4" style="max-width: 850px; margin: auto;">
    <h4 class="text-primary mb-3">‚≠ê Reviews</h4>
    <% if(listingbyid.reviews && listingbyid.reviews.length > 0) { %>
      <% listingbyid.reviews.forEach(review => { %>
        <div class="border rounded p-3 mb-3 bg-light review-box">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold"><i class="fa fa-user-circle me-1"></i> <%= review.author.username %></span>
            <span class="text-warning fw-bold">‚≠ê <%= review.rating %>/5</span>
          </div>
          <p class="mt-2"><%= review.Comment %></p>

          <% if(currUser && currUser._id.equals(review.author._id)) { %>
            <form action="/listings/<%= listingbyid._id %>/reviews/<%= review._id %>?_method=DELETE" method="post">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <p class="text-muted">No reviews yet. Be the first to review!</p>
    <% } %>
  </div>

</div>

<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Map Script -->
<script>
  const hasGeometry = <%= !!(listingbyid.geometry && listingbyid.geometry.coordinates && listingbyid.geometry.coordinates.length === 2) %>;
  let lat = 20.5937, lon = 78.9629, zoom = 5;

  if (hasGeometry) {
    lon = <%= listingbyid.geometry.coordinates[0] %>;
    lat = <%= listingbyid.geometry.coordinates[1] %>;
    zoom = 12;
  }

  const map = L.map("map").setView([lat, lon], zoom);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  if (hasGeometry) {
    L.marker([lat, lon])
      .addTo(map)
      .bindPopup(`<b><%= listingbyid.title %></b><br><%= listingbyid.location %>`)
      .openPopup();
  }
</script>

<!-- Starability CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/starability/2.4.2/starability-all.min.css"/>

<!-- Custom Styling -->
<style>
  body {
    background-color: #f9f9f9;
  }

  .listing-card {
    border-radius: 16px;
    background: #fff;
  }

  .review-box {
    transition: 0.2s ease;
  }

  .review-box:hover {
    background-color: #f3f7ff;
    transform: scale(1.01);
  }

  textarea:focus, input:focus {
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
  }

  footer {
    margin-top: 50px;
  }
</style>

</body>
